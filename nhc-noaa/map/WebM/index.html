<meta name="viewport" content="width=device-width" />
<html>
<head>
    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="whammy.js"></script>
</head>
<body>
<div>
    <div id="input">
        <input placeholder="frame rate">
        <input placeholder="count">
        <button id="btnAction">START</button>
    </div>
    <canvas id="canvas" width="1800" height="1080" ></canvas>
    <div id="output" style="display:none">
        <video id="awesome" width="800" height="600" controls autoplay loop></video><br>
        <a id="download" download="map.webm">Download WebM</a>
    <div>
</div>

<script>
    var count = 0
    var images = [];
    var video = new Whammy.Video(30);

    $.ajax({
        type: "GET",
        url: "/api/Images/EastAtlantic?count=" + 120,
        cache: false,
        success: successFunc,
        error: errorFunc
    });

    function errorFunc(err) {
        if (err.responseText === "")
            alert("Sorry the communication failed.");
        else
            alert(err.responseText);
    }

    function successFunc(data) {
        images = data;
        images.reverse();
        addFrame();
    }

    function drawImage() {
        var ctx = $('#canvas')[0].getContext('2d');
        ctx.drawImage(this, 0, 0);
        video.add(ctx);
        addFrame();
    }

    function addFrame() {
        if (count < images.length) {
            var img = new Image;
            img.onload = drawImage;
            img.src = "/api/Image?name=" + images[count++];
        } else {
            finalizeVideo()
        }
    }

    function finalizeVideo() {
        var start_time = +new Date;
        video.compile(false, function(output){
            var end_time = +new Date;
            var url = URL.createObjectURL(output);
            $('#canvas').hide();
            $('#output').show();
            $('#awesome')[0].src = url;
            $('#download')[0].href = url;
            console.log("Compiled Video in " + (end_time - start_time) + "ms, file size: " + Math.ceil(output.size / 1024) + "KB");
        });
    }
</script>

</body>
</html>
